# Device Token & Device Info Guide

## Overview

This guide explains how to get device tokens and device info for push notifications, and whether Firebase/FCM setup is required.

---

## üîë Device Token (FCM Token)

### What is it?
- A **unique token** generated by Firebase Cloud Messaging (FCM) for each device
- Used to send push notifications to that specific device
- Format: Long alphanumeric string (e.g., `fGhJkLmNoPqRsTuVwXyZ1234567890`)

### Do you need Firebase/FCM?
**YES** - You need Firebase setup to get the FCM token.

**However:**
- ‚úÖ **For push notifications**: Firebase/FCM is required
- ‚ùå **For in-app notifications**: Firebase/FCM is NOT required (they work without it)

---

## üì± Getting Device Token by Platform

### 1. **Web (Browser)**

#### Setup Required:
1. Create Firebase project
2. Enable Cloud Messaging
3. Get VAPID key from Firebase Console
4. Install Firebase SDK

#### Code Example:
```javascript
// Install: npm install firebase

import { initializeApp } from 'firebase/app';
import { getMessaging, getToken, onMessage } from 'firebase/messaging';

// Firebase config (from Firebase Console)
const firebaseConfig = {
  apiKey: "your-api-key",
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "your-app-id"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

// Get device token
async function getDeviceToken() {
  try {
    // Request notification permission
    const permission = await Notification.requestPermission();
    
    if (permission === 'granted') {
      // Get VAPID key from Firebase Console ‚Üí Project Settings ‚Üí Cloud Messaging
      const vapidKey = 'your-vapid-key';
      
      // Get token
      const token = await getToken(messaging, { vapidKey });
      
      if (token) {
        console.log('Device token:', token);
        return token;
      } else {
        console.log('No token available');
        return null;
      }
    } else {
      console.log('Notification permission denied');
      return null;
    }
  } catch (error) {
    console.error('Error getting token:', error);
    return null;
  }
}

// Register token with backend
async function registerDevice() {
  const token = await getDeviceToken();
  
  if (token) {
    await fetch('/api/notifications/devices', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        device_token: token,
        platform: 'web',
        device_info: {
          user_agent: navigator.userAgent,
          language: navigator.language,
          platform: navigator.platform
        }
      })
    });
  }
}
```

---

### 2. **Android (React Native / Native)**

#### Setup Required:
1. Firebase project
2. `google-services.json` file in Android project
3. Firebase SDK installed

#### React Native Example:
```javascript
// Install: npm install @react-native-firebase/app @react-native-firebase/messaging

import messaging from '@react-native-firebase/messaging';

async function getDeviceToken() {
  try {
    // Request permission (Android 13+)
    const authStatus = await messaging().requestPermission();
    const enabled =
      authStatus === messaging.AuthorizationStatus.AUTHORIZED ||
      authStatus === messaging.AuthorizationStatus.PROVISIONAL;

    if (enabled) {
      // Get token
      const token = await messaging().getToken();
      console.log('Device token:', token);
      return token;
    }
  } catch (error) {
    console.error('Error getting token:', error);
    return null;
  }
}

// Register with backend
async function registerDevice() {
  const token = await getDeviceToken();
  const deviceInfo = {
    model: DeviceInfo.getModel(),
    os_version: DeviceInfo.getSystemVersion(),
    app_version: DeviceInfo.getVersion()
  };
  
  await fetch('/api/notifications/devices', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      device_token: token,
      platform: 'android',
      device_info: deviceInfo
    })
  });
}
```

#### Native Android (Kotlin/Java):
```kotlin
FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
    if (!task.isSuccessful) {
        Log.w(TAG, "Fetching FCM registration token failed", task.exception)
        return@addOnCompleteListener
    }

    // Get new FCM registration token
    val token = task.result
    Log.d(TAG, "FCM Token: $token")
    
    // Register with backend
    registerDeviceWithBackend(token)
}
```

---

### 3. **iOS (React Native / Native)**

#### Setup Required:
1. Firebase project
2. `GoogleService-Info.plist` file in iOS project
3. Firebase SDK installed
4. APNs (Apple Push Notification service) configured

#### React Native Example:
```javascript
import messaging from '@react-native-firebase/messaging';

async function getDeviceToken() {
  try {
    // Request permission
    const authStatus = await messaging().requestPermission();
    
    if (authStatus === messaging.AuthorizationStatus.AUTHORIZED) {
      // Get token
      const token = await messaging().getToken();
      console.log('Device token:', token);
      return token;
    }
  } catch (error) {
    console.error('Error getting token:', error);
    return null;
  }
}

// Register with backend
async function registerDevice() {
  const token = await getDeviceToken();
  const deviceInfo = {
    model: DeviceInfo.getModel(),
    os_version: DeviceInfo.getSystemVersion(),
    app_version: DeviceInfo.getVersion()
  };
  
  await fetch('/api/notifications/devices', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      device_token: token,
      platform: 'ios',
      device_info: deviceInfo
    })
  });
}
```

---

## üìä Device Info (No Firebase Needed!)

Device info is just metadata about the device. You can get it without Firebase.

### Web (Browser):
```javascript
const deviceInfo = {
  user_agent: navigator.userAgent,
  language: navigator.language,
  platform: navigator.platform,
  screen_width: window.screen.width,
  screen_height: window.screen.height,
  timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
};
```

### React Native:
```javascript
// Install: npm install react-native-device-info
import DeviceInfo from 'react-native-device-info';

const deviceInfo = {
  model: DeviceInfo.getModel(),           // "iPhone 13"
  os_version: DeviceInfo.getSystemVersion(), // "15.0"
  app_version: DeviceInfo.getVersion(),      // "1.0.0"
  manufacturer: DeviceInfo.getManufacturer(), // "Apple"
  brand: DeviceInfo.getBrand()              // "Apple"
};
```

### Native Android (Kotlin):
```kotlin
val deviceInfo = mapOf(
    "model" to Build.MODEL,
    "manufacturer" to Build.MANUFACTURER,
    "os_version" to Build.VERSION.RELEASE,
    "sdk_version" to Build.VERSION.SDK_INT.toString()
)
```

### Native iOS (Swift):
```swift
let deviceInfo: [String: Any] = [
    "model": UIDevice.current.model,
    "os_version": UIDevice.current.systemVersion,
    "name": UIDevice.current.name
]
```

---

## üéØ Do You Need Firebase/FCM?

### **YES, if you want:**
- ‚úÖ Push notifications (when app is closed)
- ‚úÖ Background notifications
- ‚úÖ Rich notifications (images, actions)

### **NO, if you only want:**
- ‚úÖ In-app notifications (stored in database)
- ‚úÖ Notifications visible when user opens app
- ‚úÖ Real-time updates via Supabase Realtime

---

## üìã Setup Checklist

### For Push Notifications (Firebase Required):

#### 1. **Create Firebase Project**
- Go to https://console.firebase.google.com
- Create new project
- Add your app (Web/Android/iOS)

#### 2. **Get Credentials**

**For Web:**
- Project Settings ‚Üí Cloud Messaging ‚Üí Web Push certificates
- Copy **VAPID key**

**For Android:**
- Download `google-services.json`
- Place in `android/app/` directory

**For iOS:**
- Download `GoogleService-Info.plist`
- Place in iOS project root

#### 3. **Get FCM Server Key**
- Project Settings ‚Üí Cloud Messaging
- Copy **Server key** (legacy) or create **Service Account**
- Add to backend `.env`: `FCM_SERVER_KEY=your_key`

#### 4. **Install SDKs**

**Web:**
```bash
npm install firebase
```

**React Native:**
```bash
npm install @react-native-firebase/app @react-native-firebase/messaging
```

**Native Android:**
Add to `build.gradle`:
```gradle
implementation 'com.google.firebase:firebase-messaging:23.0.0'
```

**Native iOS:**
Add via CocoaPods:
```ruby
pod 'Firebase/Messaging'
```

---

## üîÑ Complete Flow Example

### Frontend (React/React Native):
```javascript
// 1. Get device token (requires Firebase)
const token = await getDeviceToken(); // Firebase SDK

// 2. Get device info (no Firebase needed)
const deviceInfo = {
  model: DeviceInfo.getModel(),
  os_version: DeviceInfo.getSystemVersion(),
  app_version: DeviceInfo.getVersion()
};

// 3. Register with backend
await fetch('/api/notifications/devices', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${accessToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    device_token: token,
    platform: 'android', // or 'ios' or 'web'
    device_info: deviceInfo
  })
});
```

### Backend (Already Implemented):
- ‚úÖ Stores device token in `user_devices` table
- ‚úÖ When notification created ‚Üí Looks up all user's device tokens
- ‚úÖ Sends push notification via FCM to all registered devices

---

## üí° Summary

| Item | Firebase Required? | How to Get |
|------|-------------------|------------|
| **Device Token (FCM)** | ‚úÖ YES | Firebase SDK (`getToken()`) |
| **Device Info** | ‚ùå NO | Device/Browser APIs |
| **Push Notifications** | ‚úÖ YES | Firebase FCM |
| **In-App Notifications** | ‚ùå NO | Supabase database |

---

## üöÄ Quick Start

### Option 1: Push Notifications (Full Setup)
1. Create Firebase project
2. Get FCM server key ‚Üí Add to `.env`
3. Install Firebase SDK in frontend
4. Get device token ‚Üí Register with backend
5. Push notifications will work!

### Option 2: In-App Only (No Firebase)
1. Skip Firebase setup
2. Notifications stored in database
3. User sees notifications when they open app
4. Use Supabase Realtime for instant updates

---

## üìö Resources

- **Firebase Console**: https://console.firebase.google.com
- **FCM Documentation**: https://firebase.google.com/docs/cloud-messaging
- **Web Setup**: https://firebase.google.com/docs/cloud-messaging/js/client
- **React Native**: https://rnfirebase.io/messaging/usage

